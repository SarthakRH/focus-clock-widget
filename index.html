<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Focus Clock — Hero</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap">

<!-- Firebase SDKs (must be before our main script) -->
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

<style>
  :root{
    --accent:#ffffff; --muted:rgba(255,255,255,.82); --soft:rgba(255,255,255,.65);
    --panel:rgba(12,14,18,.72); --panelBorder:rgba(255,255,255,.12);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Arial,sans-serif;color:#fff;background:#0b0e14;overflow:hidden}

  /* BACKGROUND */
  #bgLayer{position:fixed;inset:0;z-index:-2}
  .live-gradient{position:absolute;inset:-15%;filter:blur(40px);background:linear-gradient(120deg,#2b5876,#4e4376,#0f2027);animation:hue 40s linear infinite;opacity:.9}
  @keyframes hue{from{filter:hue-rotate(0deg) blur(40px)}to{filter:hue-rotate(360deg) blur(40px)}}
  #bgImage,#bgVideo{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}

  /* TOP BAR: small live clock + timezone */
  .topbar{position:fixed;inset:12px 16px auto 16px;display:flex;justify-content:space-between;align-items:center;gap:12px;color:var(--muted);font-weight:600;z-index:5}
  .top-left,.top-right{display:flex;gap:12px;align-items:center}
  .clock{font-variant-numeric:tabular-nums;font-weight:700;background:rgba(0,0,0,.28);border:1px solid rgba(255,255,255,.15);padding:4px 8px;border-radius:8px;color:#fff}

  /* HERO */
  .hero{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:18px}
  .tabs-line{width:min(900px,92vw);max-width:900px;position:relative;margin-bottom:12px}
  .tabs-line::before{content:"";position:absolute;left:0;right:0;top:50%;height:1px;background:rgba(255,255,255,.35);transform:translateY(-50%)}
  .focus-tabs{position:relative;display:inline-flex;gap:14px;align-items:center;padding:0 14px}
  .focus-tabs button{appearance:none;background:transparent;border:none;color:var(--soft);font-weight:800;letter-spacing:.18em;text-transform:uppercase;cursor:pointer;padding:6px 8px;font-size:13px}
  .focus-tabs button.active{color:#fff}

  /* Compact break controller */
  .mini-ctrl{display:inline-flex;align-items:center;margin-left:8px;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.22);border-radius:999px}
  .mini-btn{padding:3px 8px;border:none;background:transparent;color:#fff;cursor:pointer;font-weight:800;font-size:12px}
  .mini-btn:hover{background:rgba(255,255,255,.12)}
  .mini-val{padding:3px 8px;font-size:12px;opacity:.95}

  .time{font-size:clamp(48px,16vw,180px);font-weight:800;line-height:1;letter-spacing:.02em;text-shadow:0 10px 40px rgba(0,0,0,.45)}
  .subtitle{margin-top:8px;font-size:clamp(16px,2.5vw,28px);color:#fff;text-shadow:0 8px 30px rgba(0,0,0,.5)}

  .cta{margin-top:20px;padding:12px 26px;border:1.8px solid rgba(255,255,255,.75);color:#fff;background:rgba(255,255,255,.12);border-radius:999px;font-weight:800;letter-spacing:.06em;cursor:pointer;backdrop-filter:blur(6px)}
  .cta:hover{background:rgba(255,255,255,.18)}
  .cta-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center}
  .cta.secondary{border-color:rgba(255,255,255,.55);background:rgba(255,255,255,.08)}
  .cta.secondary:hover{background:rgba(255,255,255,.14)}

  /* Streak pill on hero */
  .streak-hero{
    margin-top:10px;
    font-weight:800;
    letter-spacing:.08em;
    text-transform:uppercase;
    font-size:12px;
    color:rgba(255,255,255,.95);
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 12px;
    background:rgba(0,0,0,.25);
    border:1px solid rgba(255,255,255,.25);
    border-radius:999px;
    backdrop-filter:blur(6px);
    box-shadow:0 10px 30px rgba(0,0,0,.25);
  }

  /* Bottom bar */
  .bottom{position:fixed;inset:auto 16px 14px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;color:var(--muted);z-index:5;flex-wrap:wrap}
  .links{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .quickbtn,.iconbtn{background:rgba(0,0,0,.28);border:1px solid rgba(255,255,255,.15);color:#fff;padding:6px 10px;border-radius:10px;font-weight:600;cursor:pointer}
  .quickbtn:hover,.iconbtn:hover{background:rgba(255,255,255,.15)}
  .hidden{display:none}

  /* Centered quote */
  .quote{margin-top:18px;text-align:center;max-width:min(900px,90vw);font-size:14px;color:#fff;text-shadow:0 6px 24px rgba(0,0,0,.55)}
  .quote .author{opacity:.8;margin-left:6px}

  /* Panels */
  .panel{position:fixed;right:16px;top:70px;bottom:16px;width:min(720px,92vw);background:var(--panel);border:1px solid var(--panelBorder);border-radius:14px;backdrop-filter:blur(16px) saturate(120%);padding:14px;overflow:auto;display:none;z-index:6}
  .panel.active{display:block}
  h2{margin:4px 0 10px 0;font-size:20px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{padding:6px 10px;border:1px solid var(--panelBorder);border-radius:999px;color:var(--muted);font-size:12px}
  input[type="number"],input[type="text"],input[type="url"],textarea{background:rgba(255,255,255,.06);border:1px solid var(--panelBorder);color:#fff;padding:8px 10px;border-radius:10px}
  textarea{width:100%;min-height:120px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px 6px;border-bottom:1px solid var(--panelBorder);font-size:13px;text-align:left}
  .notice{font-size:12px;color:var(--soft)}

  /* Toast */
  .toast{position:fixed;left:50%;bottom:100px;transform:translateX(-50%) translateY(10px);background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.25);padding:10px 14px;border-radius:10px;color:#fff;font-weight:700;opacity:0;pointer-events:none;transition:opacity .25s, transform .25s;z-index:7}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

  /* Enhanced auth hint styles */
  .auth-hint{
    position:fixed;
    left:50%;
    top:70px;
    transform:translateX(-50%);
    background:rgba(220,38,127,.9);
    border:1px solid rgba(255,255,255,.35);
    padding:12px 16px;
    border-radius:12px;
    font-size:13px;
    color:#fff;
    display:none;
    z-index:8;
    max-width:90vw;
    text-align:center;
    backdrop-filter:blur(8px);
    box-shadow:0 8px 32px rgba(0,0,0,.4);
  }
  .auth-hint.show{display:block}
  .auth-hint button{
    margin-left:10px;
    padding:4px 12px;
    font-size:11px;
    font-weight:700;
    background:rgba(255,255,255,.2);
    border:1px solid rgba(255,255,255,.4);
    color:#fff;
    border-radius:6px;
    cursor:pointer;
    text-transform:uppercase;
    letter-spacing:.5px;
  }
  .auth-hint button:hover{background:rgba(255,255,255,.3);}

  /* Auth status indicator */
  .auth-status{
    position:fixed;
    top:12px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,.4);
    border:1px solid rgba(255,255,255,.2);
    padding:6px 12px;
    border-radius:20px;
    font-size:11px;
    color:var(--muted);
    display:none;
    z-index:4;
  }
  .auth-status.show{display:block;}
  .auth-status.connected{color:#4ade80;border-color:rgba(74,222,128,.3);}
  .auth-status.error{color:#f87171;border-color:rgba(248,113,113,.3);}

  /* Export/Import data buttons */
  .data-controls{margin-top:10px;}
  .data-controls button{margin:2px;}
</style>
</head>
<body>
  <!-- BACKGROUND -->
  <div id="bgLayer">
    <div id="liveGradient" class="live-gradient"></div>
    <img id="bgImage" alt="" style="display:none">
    <video id="bgVideo" muted autoplay loop playsinline style="display:none"></video>
  </div>

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="top-left">
      <span id="nowClock" class="clock">--:--:--</span>
    </div>
    <div class="top-right">
      <span id="tzLabel"></span>
    </div>
  </div>

  <!-- Auth Status Indicator -->
  <div id="authStatus" class="auth-status"></div>

  <!-- Enhanced auth hint -->
  <div id="authHint" class="auth-hint"></div>

  <!-- HERO -->
  <main class="hero" aria-live="polite">
    <div class="tabs-line">
      <div class="focus-tabs">
        <button id="tabFocus" class="active">FOCUS</button>
        <button id="tabBreak">BREAK</button>
        <span class="mini-ctrl" id="breakCtrl">
          <button class="mini-btn" id="breakDec" title="Shorter break">−</button>
          <span id="breakLenBadge" class="mini-val">5m</span>
          <button class="mini-btn" id="breakInc" title="Longer break">+</button>
        </span>
      </div>
    </div>

    <div id="timeText" class="time">25:00</div>
    <div id="subText" class="subtitle">Focus time.</div>

    <div class="streak-hero" id="streakHeroWrap">
      🔥 <span id="streakHero">0</span>-day streak
    </div>

    <div class="cta-row">
      <button id="startStop" class="cta">START</button>
      <button id="resetBtn" class="cta secondary" title="Reset to the set time">⟲ RESET</button>
    </div>

    <div class="quote" id="quoteBox">"Small progress is still progress." <span class="author">— Unknown</span></div>

    <audio id="ding" preload="auto">
      <source src="data:audio/wav;base64,UklGRjQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABY5YWFhYWFhYWFhYQAA" type="audio/wav">
    </audio>
  </main>

  <!-- BOTTOM -->
  <div class="bottom">
    <div class="links" id="leftLinks">
      <button id="openNotes" class="quickbtn">Notes</button>
      <button id="openTodos" class="quickbtn">Todo</button>
      <button id="exportBtn" class="quickbtn">Export JSON</button>
      <input id="importFile" type="file" accept="application/json" class="hidden">
      <button id="importBtn" class="quickbtn">Import…</button>
      <button id="resetData" class="quickbtn">Reset</button>
    </div>

    <div class="links" id="rightLinks">
      <button class="iconbtn" id="authToggle">🔐 Sign in</button>
      <button class="iconbtn" id="openStats">📈 Stats</button>
      <button class="iconbtn" id="openBg">🖼️ Background</button>
      <button class="iconbtn" id="openSettings">⚙️ Settings</button>
      <button class="iconbtn" id="openSync">🔗 Sync</button>
    </div>
  </div>

  <!-- PANELS -->
  <section id="panel-stats" class="panel">
    <h2>Progress</h2>
    <div class="row" style="margin-bottom:8px;">
      <span class="pill">Goal <span id="goalPill">25</span>m</span>
      <span class="pill">Streak <span id="streakPill">0</span>🔥</span>
      <span class="pill">Free days <span id="freePill">0</span>🎟️</span>
      <span class="pill">Next free in <span id="nextFreeIn">14d</span></span>
    </div>
    <canvas id="chart" height="170"></canvas>
    <table id="logTable"><thead><tr><th>Date</th><th>Minutes</th><th>Met goal?</th><th>Used free day?</th></tr></thead><tbody></tbody></table>
    <div class="notice">If the chart is blank, that's fine—Chart.js isn't required for the timer to work.</div>
  </section>

  <section id="panel-bg" class="panel">
    <h2>Background</h2>
    <div class="row" style="margin-bottom:8px;">
      <button class="iconbtn" data-bg="gradient">Live gradient</button>
      <button class="iconbtn" data-bg="image">Image…</button>
      <button class="iconbtn" data-bg="video">Video URL…</button>
      <button class="iconbtn" data-bg="color">Solid color…</button>
      <button class="iconbtn" id="bgClear">Reset</button>
    </div>
    <div class="notice">Tip: add <code>&transparent=1</code> in the URL for transparent background (when embedded via iframe).</div>
  </section>

  <section id="panel-settings" class="panel">
    <h2>Settings</h2>
    <div class="row">
      <div><div class="notice">Session (min)</div><input id="sessionInput" type="number" min="1" max="300" value="25" style="width:120px"></div>
      <div><div class="notice">Daily goal (min)</div><input id="goalInput" type="number" min="10" max="600" value="25" style="width:120px"></div>
    </div>
    <h3 style="margin:10px 0 6px;">Break policy</h3>
    <div class="row">
      <label class="pill"><input type="radio" name="breakPolicy" value="always"> Always break</label>
      <label class="pill"><input type="radio" name="breakPolicy" value="long-only" checked> Only if session &gt; threshold</label>
      <label class="pill"><input type="radio" name="breakPolicy" value="never"> Never break</label>
    </div>
    <div class="row" style="margin-top:6px;">
      <div><div class="notice">Threshold (min)</div><input id="breakThresholdInput" type="number" min="1" max="300" value="30" style="width:120px"></div>
      <div><div class="notice">Break length (min)</div><input id="breakLenInput" type="number" min="0" max="120" value="5" style="width:120px"></div>
    </div>

    <h3 style="margin:12px 0 6px;">Notifications</h3>
    <label class="pill"><input type="checkbox" id="notifyEnable"> Desktop notification when session completes</label>

    <h3 style="margin:12px 0 6px;">Free-day automation</h3>
    <label class="pill"><input type="checkbox" id="autoApplyChk"> Auto-apply free days to recent misses</label>
    <div class="row" style="margin-top:8px;">
      <button id="applyFreeYesterday" class="iconbtn">Apply for yesterday</button>
      <button id="manageMisses" class="iconbtn">Manage missed days…</button>
    </div>

    <h3 style="margin:12px 0 6px;">Data Management</h3>
    <div class="data-controls">
      <button id="backupData" class="iconbtn">💾 Backup Data</button>
      <button id="restoreData" class="iconbtn">📂 Restore Data</button>
      <input id="restoreFile" type="file" accept="application/json" class="hidden">
    </div>

    <h3 style="margin:12px 0 6px;">Notes & Todo (saved locally)</h3>
    <textarea id="notesBox" placeholder="Quick notes…"></textarea>
    <textarea id="todoBox" placeholder="Todo list (one per line)…"></textarea>
  </section>

  <section id="panel-sync" class="panel">
    <h2>Cloud Sync & Notion Integration</h2>
    
    <div class="row" style="margin-bottom:12px;">
      <button id="forceCloudSync" class="iconbtn">☁️ Force Cloud Sync</button>
      <button id="clearCloudData" class="iconbtn">🗑️ Clear Cloud Data</button>
    </div>

    <h3>Notion Sync (optional)</h3>
    <div class="row">
      <input id="syncEndpoint" placeholder="https://your-app.vercel.app/api/notion-sync" style="flex:1;min-width:240px">
      <input id="syncDb" placeholder="Notion Database ID" style="flex:1;min-width:200px">
      <input id="syncKey" placeholder="Widget key (optional)" style="flex:1;min-width:160px">
    </div>
    <div class="row" style="margin-top:8px;">
      <label class="pill"><input type="checkbox" id="syncEnable"> Enable sync</label>
      <button id="syncNow" class="iconbtn">Sync now</button>
    </div>
    <div class="notice">Sends daily totals (date, minutes, goal, usedFreeDay) to your endpoint. Keep your Notion token server-side.</div>
  </section>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ===== Enhanced Flags & Environment Detection ===== */
var Q = new URLSearchParams(location.search);
var NS = Q.get('ns') || 'default';
var AUTO_LOGIN = Q.get('autologin') === '1';
var TRANSPARENT = Q.get('transparent') === '1';
var FORCE_LOCAL = Q.get('local') === '1'; // Force local-only mode

if(TRANSPARENT) document.body.style.background='transparent';

/* ===== Enhanced Utils ===== */
function deepClone(o){ return JSON.parse(JSON.stringify(o)); }
function $(s){ return document.querySelector(s); }
function addDays(str,n){ var d=new Date(str+"T00:00:00"); d.setDate(d.getDate()+n); return d.toLocaleDateString('en-CA'); }
function todayStr(){ return new Date().toLocaleDateString('en-CA',{timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone}); }
function clamp(v,min,max){ return Math.min(max,Math.max(min,v)); }
function fmtHM(ms){
  ms=Math.max(0,Math.floor(ms/1000));
  var h=Math.floor(ms/3600), m=Math.floor((ms%3600)/60), s=ms%60;
  return (h?String(h).padStart(2,'0')+":" :"")+String(m).padStart(2,'0')+":"+String(s).padStart(2,'0');
}
function hms(){ var d=new Date(); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'}); }
function showToast(msg){
  var t=$('#toast'); if(!t) return; t.textContent=msg; t.classList.add('show');
  clearTimeout(showToast._tid); showToast._tid=setTimeout(function(){t.classList.remove('show');},2500);
}
function isTop(){ try{ return window.top === window.self; } catch(_){ return false; } }
function isIframe(){ return !isTop(); }
function storageAvailable(type){
  try{ var s=window[type]; var x="__t"+Math.random(); s.setItem(x,"1"); var ok=s.getItem(x)==="1"; s.removeItem(x); return ok; }catch(e){ return false; }
}

// Enhanced environment detection
function getEnvironment(){
  var isInIframe = isIframe();
  var hasLocalStorage = storageAvailable('localStorage');
  var hasSessionStorage = storageAvailable('sessionStorage');
  var isThirdPartyBlocked = !hasLocalStorage || !hasSessionStorage;
  
  return {
    iframe: isInIframe,
    localStorage: hasLocalStorage,
    sessionStorage: hasSessionStorage,
    thirdPartyBlocked: isThirdPartyBlocked,
    canAuth: !isInIframe && hasSessionStorage && !isThirdPartyBlocked
  };
}

/* ===== Enhanced State Management ===== */
var LS_KEY="focusClock.hero.v3."+NS; // Updated version
var S=null;
var DEF={
  goalMinutes:25, sessionMinutes:25,
  breakMinutes:5, breakPolicy:'long-only', breakThreshold:30,
  autoApplyFreeDays:false, days:[], freeDayBank:0, runStartDate:null, runMilestonesAwarded:0, lastSeenDate:null,
  background:{mode:'gradient', color:'#0b0e14', imageDataUrl:null, videoUrl:''},
  notes:'', todos:'', notionSync:{enabled:false,endpoint:'',databaseId:'',widgetKey:''}, lastSynced:{},
  notifyEnabled:false,
  updatedAtMs:0,
  // New fields for better error handling
  authErrors: [],
  lastCloudSync: null,
  fallbackMode: false
};

function load(){ 
  try{ 
    var raw = storageAvailable('localStorage') ? localStorage.getItem(LS_KEY) : null;
    S = raw ? Object.assign({}, DEF, JSON.parse(raw)) : deepClone(DEF);
    // Migration logic for v3
    if (!S.authErrors) S.authErrors = [];
    if (!S.fallbackMode) S.fallbackMode = false;
  } catch(e){ 
    console.warn('Failed to load state:', e);
    S = deepClone(DEF);
    S.fallbackMode = true;
  } 
  normalize(); 
}

function save(){ 
  S.updatedAtMs = Date.now(); 
  try {
    if (storageAvailable('localStorage')) {
      localStorage.setItem(LS_KEY, JSON.stringify(S)); 
    }
    scheduleCloudSave(); 
  } catch(e) {
    console.warn('Failed to save state:', e);
    showToast('⚠️ Unable to save locally');
  }
}

function normalize(){
  S.goalMinutes=clamp(+S.goalMinutes||25,10,600);
  S.sessionMinutes=clamp(+S.sessionMinutes||25,1,300);
  S.breakMinutes=clamp(+S.breakMinutes||5,0,120);
  S.breakThreshold=clamp(+S.breakThreshold||30,1,300);
  if(['always','long-only','never'].indexOf(S.breakPolicy)===-1) S.breakPolicy='long-only';
}

/* ===== Streak & free-day logic ===== */
function getDay(date){ var d=S.days.find(function(x){return x.date===date;}); if(!d){ d={date:date,minutes:0,usedFreeDay:false}; S.days.push(d); S.days.sort(function(a,b){return a.date.localeCompare(b.date);}); } return d; }
function isSuccess(d){ return d.minutes>=S.goalMinutes || d.usedFreeDay; }
function recompute(){
  var today=todayStr(); var lastSeen=S.lastSeenDate||today; var cur=addDays(lastSeen,1);
  while(cur<=today){ getDay(cur); cur=addDays(cur,1); }
  if(S.autoApplyFreeDays && S.freeDayBank>0){
    var p=addDays(today,-1);
    while(p>=addDays(today,-60) && S.freeDayBank>0){
      var d=getDay(p); if(!isSuccess(d)){ d.usedFreeDay=true; S.freeDayBank--; } p=addDays(p,-1);
    }
  }
  var streak=0, runStart=null, ptr=today;
  while(true){ var dd=getDay(ptr); if(isSuccess(dd)){ streak++; runStart=ptr; } else break; ptr=addDays(ptr,-1); }
  if(S.runStartDate!==runStart){ S.runStartDate=runStart; S.runMilestonesAwarded=0; }
  var milestones=Math.floor(streak/14);
  if(milestones>S.runMilestonesAwarded){ S.freeDayBank+=milestones-S.runMilestonesAwarded; S.runMilestonesAwarded=milestones; }
  S.lastSeenDate=today; save(); return streak;
}

/* ===== Break policy ===== */
function effBreak(mins){ return (S.breakPolicy==='never'?0 : S.breakPolicy==='always'?S.breakMinutes : (mins>S.breakThreshold?S.breakMinutes:0)); }

/* ===== Notifications ===== */
function canNotify(){ return S.notifyEnabled && 'Notification' in window; }
function ensurePermission(){ if(!canNotify()) return; if(Notification.permission==='default'){ Notification.requestPermission().catch(function(){}); } }
function notifyDesktop(title, body){
  if(!canNotify()) return;
  var doShow=function(){ try{ new Notification(title,{body:body}); }catch(_){ } };
  if(Notification.permission==='granted') doShow();
  else if(Notification.permission==='default'){ Notification.requestPermission().then(function(p){ if(p==='granted') doShow(); }); }
}

/* ===== Timer ===== */
var selectedMode='work';
var Timer={
  mode:'idle', durationMs:0, remainingMs:0, endAt:null, raf:null, prevMode:'work',
  start:function(mode){ if(!mode) mode=selectedMode;
    if(mode==='work'){ this.mode='work'; this.durationMs=S.sessionMinutes*60*1000; }
    else { this.mode='break'; var b=effBreak(S.sessionMinutes); this.durationMs=b*60*1000; if(this.durationMs<=0){ alert("Break is disabled by your break policy.\n(Enable it in Settings or set session > threshold.)"); this.reset(); return; } }
    this.remainingMs=this.durationMs; this.endAt=performance.now()+this.remainingMs; updateModeLabels(); this.tick();
  },
  pause:function(){ if(this.mode==='work'||this.mode==='break'){ this.remainingMs=Math.max(0,this.endAt-performance.now());
