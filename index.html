<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Focus Clock ‚Äî Hero</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap">
<!-- Firebase SDKs (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

<style>
  :root{ --accent:#ffffff; --muted:rgba(255,255,255,.82); --soft:rgba(255,255,255,.65); --panel:rgba(12,14,18,.72); --panelBorder:rgba(255,255,255,.12); }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Arial,sans-serif;color:#fff;background:#0b0e14;overflow:hidden}
  #bgLayer{position:fixed;inset:0;z-index:-2}
  .live-gradient{position:absolute;inset:-15%;filter:blur(40px);background:linear-gradient(120deg,#2b5876,#4e4376,#0f2027);animation:hue 40s linear infinite;opacity:.9}
  @keyframes hue{from{filter:hue-rotate(0deg) blur(40px)}to{filter:hue-rotate(360deg) blur(40px)}}
  #bgImage,#bgVideo{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .topbar{position:fixed;inset:12px 16px auto 16px;display:flex;justify-content:space-between;align-items:center;gap:12px;color:var(--muted);font-weight:600;z-index:5}
  .top-left,.top-right{display:flex;gap:12px;align-items:center}
  .clock{font-variant-numeric:tabular-nums;font-weight:700;background:rgba(0,0,0,.28);border:1px solid rgba(255,255,255,.15);padding:4px 8px;border-radius:8px;color:#fff}
  .hero{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:18px}
  .tabs-line{width:min(900px,92vw);max-width:900px;position:relative;margin-bottom:12px}
  .tabs-line::before{content:"";position:absolute;left:0;right:0;top:50%;height:1px;background:rgba(255,255,255,.35);transform:translateY(-50%)}
  .focus-tabs{position:relative;display:inline-flex;gap:14px;align-items:center;padding:0 14px}
  .focus-tabs button{appearance:none;background:transparent;border:none;color:var(--soft);font-weight:800;letter-spacing:.18em;text-transform:uppercase;cursor:pointer;padding:6px 8px;font-size:13px}
  .focus-tabs button.active{color:#fff}
  .mini-ctrl{display:inline-flex;align-items:center;margin-left:8px;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.22);border-radius:999px}
  .mini-btn{padding:3px 8px;border:none;background:transparent;color:#fff;cursor:pointer;font-weight:800;font-size:12px}
  .mini-btn:hover{background:rgba(255,255,255,.12)}
  .mini-val{padding:3px 8px;font-size:12px;opacity:.95}
  .time{font-size:clamp(48px,16vw,180px);font-weight:800;line-height:1;letter-spacing:.02em;text-shadow:0 10px 40px rgba(0,0,0,.45)}
  .subtitle{margin-top:8px;font-size:clamp(16px,2.5vw,28px);color:#fff;text-shadow:0 8px 30px rgba(0,0,0,.5)}
  .cta{margin-top:20px;padding:12px 26px;border:1.8px solid rgba(255,255,255,.75);color:#fff;background:rgba(255,255,255,.12);border-radius:999px;font-weight:800;letter-spacing:.06em;cursor:pointer;backdrop-filter:blur(6px)}
  .cta:hover{background:rgba(255,255,255,.18)}
  .cta-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center}
  .cta.secondary{border-color:rgba(255,255,255,.55);background:rgba(255,255,255,.08)}
  .cta.secondary:hover{background:rgba(255,255,255,.14)}
  .streak-hero{margin-top:10px;font-weight:800;letter-spacing:.08em;text-transform:uppercase;font-size:12px;color:rgba(255,255,255,.95);display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.25);border-radius:999px;backdrop-filter:blur(6px);box-shadow:0 10px 30px rgba(0,0,0,.25);}
  .bottom{position:fixed;inset:auto 16px 14px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;color:var(--muted);z-index:5;flex-wrap:wrap}
  .links{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .quickbtn,.iconbtn{background:rgba(0,0,0,.28);border:1px solid rgba(255,255,255,.15);color:#fff;padding:6px 10px;border-radius:10px;font-weight:600;cursor:pointer}
  .quickbtn:hover,.iconbtn:hover{background:rgba(255,255,255,.15)}
  .hidden{display:none}
  .quote{margin-top:18px;text-align:center;max-width:min(900px,90vw);font-size:14px;color:#fff;text-shadow:0 6px 24px rgba(0,0,0,.55)}
  .quote .author{opacity:.8;margin-left:6px}
  .panel{position:fixed;right:16px;top:70px;bottom:16px;width:min(720px,92vw);background:var(--panel);border:1px solid var(--panelBorder);border-radius:14px;backdrop-filter:blur(16px) saturate(120%);padding:14px;overflow:auto;display:none;z-index:6}
  .panel.active{display:block}
  h2{margin:4px 0 10px 0;font-size:20px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{padding:6px 10px;border:1px solid var(--panelBorder);border-radius:999px;color:var(--muted);font-size:12px}
  input[type="number"],input[type="text"],input[type="url"],textarea{background:rgba(255,255,255,.06);border:1px solid var(--panelBorder);color:#fff;padding:8px 10px;border-radius:10px}
  textarea{width:100%;min-height:120px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px 6px;border-bottom:1px solid var(--panelBorder);font-size:13px;text-align:left}
  .notice{font-size:12px;color:var(--soft)}
  .toast{position:fixed;left:50%;bottom:100px;transform:translateX(-50%) translateY(10px);background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.25);padding:10px 14px;border-radius:10px;color:#fff;font-weight:700;opacity:0;pointer-events:none;transition:opacity .25s, transform .25s;z-index:7}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>

<!-- BACKGROUND -->
<div id="bgLayer">
  <div id="liveGradient" class="live-gradient"></div>
  <img id="bgImage" alt="" style="display:none">
  <video id="bgVideo" muted autoplay loop playsinline style="display:none"></video>
</div>

<!-- TOP BAR -->
<div class="topbar">
  <div class="top-left"><span id="nowClock" class="clock">--:--:--</span></div>
  <div class="top-right"><span id="tzLabel"></span></div>
</div>

<!-- HERO -->
<main class="hero" aria-live="polite">
  <div class="tabs-line">
    <div class="focus-tabs">
      <button id="tabFocus" class="active">FOCUS</button>
      <button id="tabBreak">BREAK</button>
      <span class="mini-ctrl" id="breakCtrl">
        <button class="mini-btn" id="breakDec" title="Shorter break">‚àí</button>
        <span id="breakLenBadge" class="mini-val">5m</span>
        <button class="mini-btn" id="breakInc" title="Longer break">+</button>
      </span>
    </div>
  </div>

  <div id="timeText" class="time">25:00</div>
  <div id="subText" class="subtitle">Focus time.</div>

  <div class="streak-hero" id="streakHeroWrap">üî• <span id="streakHero">0</span>-day streak</div>

  <div class="cta-row">
    <button id="startStop" class="cta">START</button>
    <button id="resetBtn" class="cta secondary" title="Reset to the set time">‚ü≤ RESET</button>
  </div>

  <div class="quote" id="quoteBox">‚ÄúSmall progress is still progress.‚Äù <span class="author">‚Äî Unknown</span></div>

  <audio id="ding" preload="auto">
    <source src="data:audio/wav;base64,UklGRjQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABY5YWFhYWFhYWFhYQAA" type="audio/wav">
  </audio>
</main>

<!-- BOTTOM -->
<div class="bottom">
  <div class="links" id="leftLinks">
    <button id="openNotes" class="quickbtn">Notes</button>
    <button id="openTodos" class="quickbtn">Todo</button>
    <button id="exportBtn" class="quickbtn">Export JSON</button>
    <input id="importFile" type="file" accept="application/json" class="hidden">
    <button id="importBtn" class="quickbtn">Import‚Ä¶</button>
    <button id="resetData" class="quickbtn">Reset</button>
  </div>

  <div class="links" id="rightLinks">
    <button class="iconbtn" id="authToggle">üîê Sign in</button>
    <button class="iconbtn" id="openStats">üìà Stats</button>
    <button class="iconbtn" id="openBg">üñºÔ∏è Background</button>
    <button class="iconbtn" id="openSettings">‚öôÔ∏è Settings</button>
    <button class="iconbtn" id="openSync">üîó Sync</button>
  </div>
</div>

<!-- PANELS -->
<section id="panel-stats" class="panel">
  <h2>Progress</h2>
  <div class="row" style="margin-bottom:8px;">
    <span class="pill">Goal <span id="goalPill">25</span>m</span>
    <span class="pill">Streak <span id="streakPill">0</span>üî•</span>
    <span class="pill">Free days <span id="freePill">0</span>üéüÔ∏è</span>
    <span class="pill">Next free in <span id="nextFreeIn">14d</span></span>
  </div>
  <canvas id="chart" height="170"></canvas>
  <table id="logTable"><thead><tr><th>Date</th><th>Minutes</th><th>Met goal?</th><th>Used free day?</th></tr></thead><tbody></tbody></table>
  <div class="notice">If the chart is blank, that‚Äôs fine‚ÄîChart.js isn‚Äôt required for the timer to work.</div>
</section>

<section id="panel-bg" class="panel">
  <h2>Background</h2>
  <div class="row" style="margin-bottom:8px;">
    <button class="iconbtn" data-bg="gradient">Live gradient</button>
    <button class="iconbtn" data-bg="image">Image‚Ä¶</button>
    <button class="iconbtn" data-bg="video">Video URL‚Ä¶</button>
    <button class="iconbtn" data-bg="color">Solid color‚Ä¶</button>
    <button class="iconbtn" id="bgClear">Reset</button>
  </div>
  <div class="notice">Tip: add <code>&transparent=1</code> in the URL for transparent background (when embedded via iframe).</div>
</section>

<section id="panel-settings" class="panel">
  <h2>Settings</h2>
  <div class="row">
    <div><div class="notice">Session (min)</div><input id="sessionInput" type="number" min="1" max="300" value="25" style="width:120px"></div>
    <div><div class="notice">Daily goal (min)</div><input id="goalInput" type="number" min="10" max="600" value="25" style="width:120px"></div>
  </div>

  <h3 style="margin:10px 0 6px;">Break policy</h3>
  <div class="row">
    <label class="pill"><input type="radio" name="breakPolicy" value="always"> Always break</label>
    <label class="pill"><input type="radio" name="breakPolicy" value="long-only" checked> Only if session &gt; threshold</label>
    <label class="pill"><input type="radio" name="breakPolicy" value="never"> Never break</label>
  </div>
  <div class="row" style="margin-top:6px;">
    <div><div class="notice">Threshold (min)</div><input id="breakThresholdInput" type="number" min="1" max="300" value="30" style="width:120px"></div>
    <div><div class="notice">Break length (min)</div><input id="breakLenInput" type="number" min="0" max="120" value="5" style="width:120px"></div>
  </div>

  <h3 style="margin:12px 0 6px;">Notifications</h3>
  <label class="pill"><input type="checkbox" id="notifyEnable"> Desktop notification when session completes</label>

  <h3 style="margin:12px 0 6px;">Public mirror for Notion</h3>
  <label class="pill"><input type="checkbox" id="pubMirrorEnable"> Expose read-only profile (for embeds)</label>
  <div class="row" style="gap:8px;margin-top:6px;">
    <button id="copyNotionUrl" class="iconbtn" title="Copy read-only embed URL with your UID">Copy Notion URL (read)</button>
    <button id="copyNotionUrlWrite" class="iconbtn" title="Copy write-enabled embed URL with widget key">Copy Notion URL (write)</button>
  </div>
  <span class="notice" id="uidLabel"></span>

  <h3 style="margin:12px 0 6px;">Free-day automation</h3>
  <label class="pill"><input type="checkbox" id="autoApplyChk"> Auto-apply free days to recent misses</label>
  <div class="row" style="margin-top:8px;">
    <button id="applyFreeYesterday" class="iconbtn">Apply for yesterday</button>
    <button id="manageMisses" class="iconbtn">Manage missed days‚Ä¶</button>
  </div>

  <h3 style="margin:12px 0 6px;">Notes & Todo (saved locally)</h3>
  <textarea id="notesBox" placeholder="Quick notes‚Ä¶"></textarea>
  <textarea id="todoBox" placeholder="Todo list (one per line)‚Ä¶"></textarea>
</section>

<section id="panel-sync" class="panel">
  <h2>Notion Sync (optional)</h2>
  <div class="row">
    <input id="syncEndpoint" placeholder="https://your-app.example/functions/notion-sync" style="flex:1;min-width:240px">
    <input id="syncDb" placeholder="Notion Database ID" style="flex:1;min-width:200px">
    <input id="syncKey" placeholder="Widget key (optional, used for write-embed URL)" style="flex:1;min-width:220px">
  </div>
  <div class="row" style="margin-top:8px;">
    <label class="pill"><input type="checkbox" id="syncEnable"> Enable sync</label>
    <button id="syncNow" class="iconbtn">Sync now</button>
  </div>
  <div class="notice">Sends daily totals (date, minutes, goal, usedFreeDay) to your endpoint. Keep your Notion token server-side.</div>
</section>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ===== URL params / constants ===== */
var Q = new URLSearchParams(location.search);
var NS = Q.get('ns') || 'default';
var UID_PARAM = Q.get('uid') || '';   // read-only public mirror mode
var KEY_PARAM = Q.get('key') || '';   // write-enabled embed via custom token
var IN_IFRAME = (function(){ try { return window.top !== window.self; } catch (_) { return true; }})();
var TRANSPARENT = Q.get('transparent') === '1';
if (TRANSPARENT) document.body.style.background='transparent';

/* IMPORTANT: set this to your Firebase Cloud Functions URL */
var TOKEN_ENDPOINT = 'https://us-central1-YOUR_PROJECT.cloudfunctions.net/issueEmbedToken';

/* ===== Utils ===== */
function deepClone(o){ return JSON.parse(JSON.stringify(o)); }
function $(s){ return document.querySelector(s); }
function addDays(str,n){ var d=new Date(str+"T00:00:00"); d.setDate(d.getDate()+n); return d.toLocaleDateString('en-CA'); }
function todayStr(){ return new Date().toLocaleDateString('en-CA',{timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone}); }
function clamp(v,min,max){ return Math.min(max,Math.max(min,v)); }
function fmtHM(ms){ ms=Math.max(0,Math.floor(ms/1000)); var h=Math.floor(ms/3600), m=Math.floor((ms%3600)/60), s=ms%60; return (h?String(h).padStart(2,'0')+":" :"")+String(m).padStart(2,'0')+":"+String(s).padStart(2,'0'); }
function hms(){ var d=new Date(); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'}); }
function showToast(msg){ var t=$('#toast'); if(!t) return; t.textContent=msg; t.classList.add('show'); clearTimeout(showToast._tid); showToast._tid=setTimeout(function(){t.classList.remove('show');},2500); }

/* ===== State ===== */
var LS_KEY="focusClock.hero.v2."+NS;
var S=null;
var DEF={
  goalMinutes:25, sessionMinutes:25,
  breakMinutes:5, breakPolicy:'long-only', breakThreshold:30,
  autoApplyFreeDays:false, days:[], freeDayBank:0, runStartDate:null, runMilestonesAwarded:0, lastSeenDate:null,
  background:{mode:'gradient', color:'#0b0e14', imageDataUrl:null, videoUrl:''},
  notes:'', todos:'',
  notionSync:{enabled:false,endpoint:'',databaseId:'',widgetKey:''},
  lastSynced:{},
  notifyEnabled:false,
  publicMirrorEnabled:true,
  updatedAtMs:0
};
function load(){ try{ var raw=localStorage.getItem(LS_KEY); S = raw? Object.assign({}, DEF, JSON.parse(raw)) : deepClone(DEF);}catch(e){ S=deepClone(DEF);} normalize(); }
function save(){ S.updatedAtMs = Date.now(); localStorage.setItem(LS_KEY, JSON.stringify(S)); scheduleCloudSave(); }
function normalize(){
  S.goalMinutes=clamp(+S.goalMinutes||25,10,600);
  S.sessionMinutes=clamp(+S.sessionMinutes||25,1,300);
  S.breakMinutes=clamp(+S.breakMinutes||5,0,120);
  S.breakThreshold=clamp(+S.breakThreshold||30,1,300);
  if(['always','long-only','never'].indexOf(S.breakPolicy)===-1) S.breakPolicy='long-only';
}

/* ===== Streak & free-day logic ===== */
function getDay(date){ var d=S.days.find(function(x){return x.date===date;}); if(!d){ d={date:date,minutes:0,usedFreeDay:false}; S.days.push(d); S.days.sort(function(a,b){return a.date.localeCompare(b.date);}); } return d; }
function isSuccess(d){ return d.minutes>=S.goalMinutes || d.usedFreeDay; }
function recompute(){
  var today=todayStr(); var lastSeen=S.lastSeenDate||today; var cur=addDays(lastSeen,1);
  while(cur<=today){ getDay(cur); cur=addDays(cur,1); }
  if(S.autoApplyFreeDays && S.freeDayBank>0){
    var p=addDays(today,-1);
    while(p>=addDays(today,-60) && S.freeDayBank>0){
      var d=getDay(p); if(!isSuccess(d)){ d.usedFreeDay=true; S.freeDayBank--; } p=addDays(p,-1);
    }
  }
  var streak=0, runStart=null, ptr=today;
  while(true){ var dd=getDay(ptr); if(isSuccess(dd)){ streak++; runStart=ptr; } else break; ptr=addDays(ptr,-1); }
  if(S.runStartDate!==runStart){ S.runStartDate=runStart; S.runMilestonesAwarded=0; }
  var milestones=Math.floor(streak/14);
  if(milestones>S.runMilestonesAwarded){ S.freeDayBank+=milestones-S.runMilestonesAwarded; S.runMilestonesAwarded=milestones; }
  S.lastSeenDate=today; save(); return streak;
}

/* ===== Breaks / notifications / timer ===== */
function effBreak(mins){ return (S.breakPolicy==='never'?0 : S.breakPolicy==='always'?S.breakMinutes : (mins>S.breakThreshold?S.breakMinutes:0)); }
function canNotify(){ return S.notifyEnabled && 'Notification' in window; }
function ensurePermission(){ if(!canNotify()) return; if(Notification.permission==='default'){ Notification.requestPermission().catch(function(){}); } }
function notifyDesktop(title, body){
  if(!canNotify()) return;
  var doShow=function(){ try{ new Notification(title,{body:body}); }catch(_){ } };
  if(Notification.permission==='granted') doShow();
  else if(Notification.permission==='default'){ Notification.requestPermission().then(function(p){ if(p==='granted') doShow(); }); }
}
var selectedMode='work';
var Timer={
  mode:'idle', durationMs:0, remainingMs:0, endAt:null, raf:null, prevMode:'work',
  start:function(mode){ if(!mode) mode=selectedMode;
    if(mode==='work'){ this.mode='work'; this.durationMs=S.sessionMinutes*60*1000; }
    else { this.mode='break'; var b=effBreak(S.sessionMinutes); this.durationMs=b*60*1000; if(this.durationMs<=0){ alert("Break is disabled by your break policy.\n(Enable it in Settings or set session > threshold.)"); this.reset(); return; } }
    this.remainingMs=this.durationMs; this.endAt=performance.now()+this.remainingMs; updateModeLabels(); this.tick();
  },
  pause:function(){ if(this.mode==='work'||this.mode==='break'){ this.remainingMs=Math.max(0,this.endAt-performance.now()); this.prevMode=this.mode; this.mode='paused'; cancelAnimationFrame(this.raf); $('#startStop').textContent='RESUME'; updateTimeText(this.remainingMs); $('#subText').textContent='Paused'; } },
  resume:function(){ if(this.mode==='paused'){ this.endAt=performance.now()+this.remainingMs; this.mode=this.prevMode||'work'; updateModeLabels(); this.tick(); } },
  reset:function(){ cancelAnimationFrame(this.raf); this.mode='idle'; this.remainingMs=(selectedMode==='work'? S.sessionMinutes: effBreak(S.sessionMinutes))*60*1000; updateTimeText(this.remainingMs); $('#startStop').textContent='START'; $('#subText').textContent= selectedMode==='work' ? 'Focus time.' : (effBreak(S.sessionMinutes)>0?'Break time.':'Break disabled by policy'); },
  tick:function(){ var self=this; this.raf=requestAnimationFrame(function(){ self.tick(); }); var left=Math.max(0,this.endAt-performance.now()); this.remainingMs=left; updateTimeText(left); if(left<=0){ cancelAnimationFrame(this.raf); this.done(); } },
  done:function(){
    try{ var ding=$('#ding'); ding.currentTime=0; ding.play().catch(function(){});}catch(_){}
    if(this.mode==='work'){
      var mins=Math.round(this.durationMs/60000);
      var d=getDay(todayStr()); d.minutes+=mins; save(); refreshStats(); queueSync(todayStr());
      showToast('Focus complete ‚Ä¢ '+mins+' min logged'); notifyDesktop('Focus complete', mins+' minutes logged');
      var b=effBreak(S.sessionMinutes);
      if(b>0){ this.mode='break'; this.durationMs=b*60*1000; this.remainingMs=this.durationMs; this.endAt=performance.now()+this.remainingMs; updateModeLabels(); this.tick(); }
      else { this.reset(); }
    } else {
      showToast('Break over ‚Ä¢ Back to focus'); notifyDesktop('Break over', 'Time to focus again'); this.reset();
    }
  }
};
function updateTimeText(ms){ $('#timeText').textContent=fmtHM(ms); }
function updateModeLabels(){
  if(Timer.mode==='work'){ $('#tabFocus').classList.add('active'); $('#tabBreak').classList.remove('active'); $('#subText').textContent='Focus time.'; $('#startStop').textContent='PAUSE'; }
  if(Timer.mode==='break'){ $('#tabBreak').classList.add('active'); $('#tabFocus').classList.remove('active'); $('#subText').textContent='Break time.'; $('#startStop').textContent='PAUSE'; }
}

/* ===== Panels / background / stats / quotes ===== */
function showPanel(id){ document.querySelectorAll('.panel').forEach(function(p){p.classList.remove('active');}); $(id).classList.add('active'); }
function hidePanels(){ document.querySelectorAll('.panel').forEach(function(p){p.classList.remove('active');}); }
function applyBackground(){
  var live=$('#liveGradient'), img=$('#bgImage'), vid=$('#bgVideo');
  live.style.display=img.style.display=vid.style.display='none';
  if(S.background.mode==='gradient'){ live.style.display='block'; }
  else if(S.background.mode==='image' && S.background.imageDataUrl){ img.src=S.background.imageDataUrl; img.style.display='block'; }
  else if(S.background.mode==='video' && S.background.videoUrl){ vid.src=S.background.videoUrl; vid.style.display='block'; }
  else if(S.background.mode==='color'){ document.body.style.background=S.background.color||'#0b0e14'; }
}
function refreshStats(){
  var streak = recompute();
  $('#goalPill').textContent=S.goalMinutes;
  $('#freePill').textContent=S.freeDayBank;
  $('#streakPill').textContent=streak;
  var sh=document.getElementById('streakHero'); if (sh) sh.textContent = streak;
  var toNext = 14 - (streak % 14 || 14);
  $('#nextFreeIn').textContent=toNext+'d';
  var tb=$('#logTable tbody'); tb.innerHTML='';
  [].concat(S.days).sort(function(a,b){return b.date.localeCompare(a.date);}).slice(0,60).forEach(function(d){
    var tr=document.createElement('tr'); var meet=isSuccess(d);
    tr.innerHTML='<td>'+new Date(d.date+"T00:00:00").toLocaleDateString([], {weekday:"short", month:"short", day:"numeric"})+
                 '</td><td>'+d.minutes+'</td><td>'+(meet?'Yes':'No')+'</td><td>'+(d.usedFreeDay?'Yes':'No')+'</td>';
    tb.appendChild(tr);
  });
}
var QUOTES=[["You cannot swim for new horizons until you have courage to lose sight of the shore.","William Faulkner"],["Focus is the art of knowing what to ignore.","James Clear"],["The secret of getting ahead is getting started.","Mark Twain"],["It always seems impossible until it‚Äôs done.","Nelson Mandela"],["Small progress is still progress.","Unknown"]];
function setQuote(){ var qa=QUOTES[(new Date().getDate())%QUOTES.length]; $('#quoteBox').innerHTML='‚Äú'+qa[0]+'‚Äù <span class="author">‚Äî '+qa[1]+'</span>'; }

/* ===== Firebase config (yours) ===== */
var firebaseConfig = {
  apiKey: "AIzaSyC7fhspLB7sNThCwRt2k8qsKcAOb_Fr6dU",
  authDomain: "streak-clock.firebaseapp.com",
  projectId: "streak-clock",
  appId: "1:131829224528:web:e1c75d85e1311c30026d55"
};

/* ===== Cloud: auth + public mirror (iframe-safe) ===== */
var CLOUD = {enabled:false, app:null, auth:null, db:null, user:null, unsub:null, unsubPublic:null};

function profileRef(){ return CLOUD.db.collection('users').doc(CLOUD.user.uid).collection('profiles').doc(NS); }
function publicRef(uid){ return CLOUD.db.collection('public').doc(uid).collection('profiles').doc(NS); }

function applyRemoteState(remote){
  S = Object.assign({}, S, remote);
  localStorage.setItem(LS_KEY, JSON.stringify(S));
  applyBackground();
  if(Timer.mode==='idle'){ Timer.reset(); }
  refreshStats();
}

// Read-only public listener (embed)
function listenPublic(uid){
  if (!CLOUD.enabled || !uid) return;
  if (CLOUD.unsubPublic) { CLOUD.unsubPublic(); CLOUD.unsubPublic = null; }
  CLOUD.unsubPublic = publicRef(uid).onSnapshot(function(doc){
    if(!doc.exists) return;
    var d=doc.data(); var remote=d.state||d;
    applyRemoteState(remote);
  }, function(e){ console.warn('Public mirror listen error:', e); });
}

async function authenticateIframeWithWidgetKey(){
  try{
    if (!KEY_PARAM || !TOKEN_ENDPOINT || TOKEN_ENDPOINT.indexOf('YOUR_PROJECT') !== -1) return false;
    const res = await fetch(TOKEN_ENDPOINT, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ key: KEY_PARAM, ns: NS })
    });
    if (!res.ok) {
      console.warn('Failed to fetch custom token for iframe:', await res.text());
      return false;
    }
    const data = await res.json();
    if (!data || !data.token) return false;
    await CLOUD.auth.signInWithCustomToken(data.token);
    return true;
  } catch (e){
    console.warn('authenticateIframeWithWidgetKey error:', e);
    return false;
  }
}

function initCloud(){
  try{
    if(!firebaseConfig || !firebaseConfig.apiKey){ CLOUD.enabled=false; return; }
    CLOUD.app  = firebase.initializeApp(firebaseConfig);
    CLOUD.db   = firebase.firestore();
    CLOUD.auth = firebase.auth();
    CLOUD.enabled = true;

    if (IN_IFRAME) {
      // Don‚Äôt run OAuth in Notion; use in-memory auth + custom token
      CLOUD.auth.setPersistence(firebase.auth.Auth.Persistence.NONE).catch(function(){});
      authenticateIframeWithWidgetKey().then(function(ok){
        renderAuthButton(); // hides in iframe
        if (ok) {
          CLOUD.user = CLOUD.auth.currentUser;
          if (CLOUD.unsub) { CLOUD.unsub(); CLOUD.unsub = null; }
          syncFromCloud();
        } else if (UID_PARAM) {
          // Fallback: read-only public mirror
          listenPublic(UID_PARAM);
        } else {
          // Neither key nor uid: show subtle hint
          showToast('Embed is read-only. Add ?uid=... (read) or ?key=... (write).');
        }
      });
    } else {
      // Top-level: normal Google OAuth
      CLOUD.auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(function(){});
      CLOUD.auth.onAuthStateChanged(function(user){
        CLOUD.user = user || null;
        renderAuthButton();
        if(CLOUD.unsub){ CLOUD.unsub(); CLOUD.unsub=null; }
        if(user){ syncFromCloud(); $('#uidLabel').textContent='UID: '+user.uid; }
      });
    }
  }catch(e){
    console.warn("Cloud init failed:", e); CLOUD.enabled=false;
  }
}

function renderAuthButton(){
  var btn=$('#authToggle'); if(!btn) return;
  if (IN_IFRAME) { btn.style.display='none'; return; } // hide controls inside Notion

  if(!CLOUD.enabled){ btn.textContent='üîê Sign in'; btn.onclick=function(){ alert('Add Firebase config'); }; return; }
  if(CLOUD.user){
    var name=(CLOUD.user.displayName||CLOUD.user.email||'Account').split(' ')[0];
    btn.textContent='üîì Sign out ('+name+')';
    btn.onclick=function(){ CLOUD.auth.signOut().catch(function(e){ alert('Sign-out failed: '+e.message); }); };
  }else{
    btn.textContent='üîê Sign in';
    btn.onclick=function(){
      var provider=new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({prompt:'select_account'});
      CLOUD.auth.signInWithPopup(provider).catch(function(){
        CLOUD.auth.signInWithRedirect(provider).catch(function(err){
          alert('Sign-in blocked. Please allow popups or try another browser.\n'+(err && err.message ? err.message : ''));
        });
      });
    };
  }
}

function syncFromCloud(){
  var ref=profileRef();
  // Initial pull
  ref.get().then(function(snap){
    if(snap.exists){
      var data=snap.data(); var remote=data.state||data;
      if((remote.updatedAtMs||0) >= (S.updatedAtMs||0)){ applyRemoteState(remote); }
      else { saveToCloud(); }
    }else{ saveToCloud(); }
  }).catch(function(e){ console.warn('Initial cloud load failed:', e); });

  // Live updates
  CLOUD.unsub = ref.onSnapshot(function(doc){
    if(!doc.exists) return;
    var d=doc.data(); var remote=d.state||d;
    if((remote.updatedAtMs||0) > (S.updatedAtMs||0)){ applyRemoteState(remote); }
  });
}

var cloudTimer=null;
function scheduleCloudSave(){ if(!(CLOUD.enabled && CLOUD.user)) return; if(cloudTimer) clearTimeout(cloudTimer); cloudTimer=setTimeout(saveToCloud, 500); }
function filteredPublicState(s){
  return {
    goalMinutes:s.goalMinutes, sessionMinutes:s.sessionMinutes,
    breakMinutes:s.breakMinutes, breakPolicy:s.breakPolicy, breakThreshold:s.breakThreshold,
    autoApplyFreeDays:s.autoApplyFreeDays, days:s.days, freeDayBank:s.freeDayBank,
    runStartDate:s.runStartDate, runMilestonesAwarded:s.runMilestonesAwarded, lastSeenDate:s.lastSeenDate,
    notifyEnabled:s.notifyEnabled, updatedAtMs:s.updatedAtMs
  };
}
function saveToCloud(){
  if(!(CLOUD.enabled && CLOUD.user)) return;
  var uid = CLOUD.user.uid;
  var ref=profileRef();
  var payload={ ns:NS, version:2, state:S, updatedAtMs:S.updatedAtMs||Date.now(), updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
  ref.set(payload,{merge:true}).catch(function(e){ console.warn('Cloud save failed:', e); });
  if (S.publicMirrorEnabled) {
    publicRef(uid).set({ ns:NS, version:2, state: filteredPublicState(S),
                         updatedAtMs:S.updatedAtMs||Date.now(),
                         updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true})
      .catch(function(e){ console.warn('Public mirror save failed:', e); });
  }
}

/* ===== Notion sync payload (optional) ===== */
function signatureFor(d){ return [d.minutes,S.goalMinutes,d.usedFreeDay].join('|'); }
function queueSync(dateStr){
  if(!(S.notionSync && S.notionSync.enabled && S.notionSync.endpoint && S.notionSync.databaseId)) return;
  var d=getDay(dateStr); var sig=signatureFor(d);
  if(S.lastSynced[dateStr]===sig) return;
  fetch(S.notionSync.endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({databaseId:S.notionSync.databaseId, date:dateStr, minutes:d.minutes, goal:S.goalMinutes, usedFreeDay:d.usedFreeDay})})
    .then(function(r){return r.json().catch(function(){return {};});})
    .then(function(){ S.lastSynced[dateStr]=sig; save(); })
    .catch(function(){});
}

/* ===== Wiring ===== */
function wire(){
  // Panels
  $('#openStats').onclick=function(){showPanel('#panel-stats');};
  $('#openBg').onclick=function(){showPanel('#panel-bg');};
  $('#openSettings').onclick=function(){showPanel('#panel-settings');};
  $('#openSync').onclick=function(){showPanel('#panel-sync');};
  document.addEventListener('keydown',function(e){ if(e.key==='Escape') hidePanels(); });

  // Tabs
  $('#tabFocus').onclick=function(){ selectedMode='work'; $('#tabFocus').classList.add('active'); $('#tabBreak').classList.remove('active'); $('#subText').textContent='Focus time.'; updateTimeText(S.sessionMinutes*60*1000); if(Timer.mode==='idle') Timer.reset(); };
  $('#tabBreak').onclick=function(){ selectedMode='break'; $('#tabBreak').classList.add('active'); $('#tabFocus').classList.remove('active'); var b=effBreak(S.sessionMinutes); $('#subText').textContent=b>0?'Break time.':'Break disabled by policy'; updateTimeText(b*60*1000); if(Timer.mode==='idle') Timer.reset(); };

  // Break controller
  function updateBreakBadge(){ var badge=$('#breakLenBadge'); if(badge) badge.textContent=(S.breakMinutes|0)+'m'; }
  $('#breakDec').onclick=function(){
    var old=S.breakMinutes; S.breakMinutes=clamp(S.breakMinutes-1,0,120); $('#breakLenInput').value=S.breakMinutes; save(); updateBreakBadge();
    if(Timer.mode==='break'){ var delta=(S.breakMinutes-old)*60*1000; Timer.remainingMs=Math.max(0,Timer.remainingMs+delta); Timer.endAt=performance.now()+Timer.remainingMs; updateTimeText(Timer.remainingMs); }
    if(selectedMode==='break' && Timer.mode==='idle') updateTimeText(effBreak(S.sessionMinutes)*60*1000);
  };
  $('#breakInc').onclick=function(){
    var old=S.breakMinutes; S.breakMinutes=clamp(S.breakMinutes+1,0,120); $('#breakLenInput').value=S.breakMinutes; save(); updateBreakBadge();
    if(Timer.mode==='break'){ var delta=(S.breakMinutes-old)*60*1000; Timer.remainingMs=Math.max(0,Timer.remainingMs+delta); Timer.endAt=performance.now()+Timer.remainingMs; updateTimeText(Timer.remainingMs); }
    if(selectedMode==='break' && Timer.mode==='idle') updateTimeText(effBreak(S.sessionMinutes)*60*1000);
  };
  updateBreakBadge();

  // Controls
  $('#startStop').onclick=function(){ if(Timer.mode==='idle') Timer.start(selectedMode); else if(Timer.mode==='paused') Timer.resume(); else Timer.pause(); };
  $('#resetBtn').onclick=function(){ Timer.reset(); };

  // Settings
  $('#sessionInput').onchange=function(e){ S.sessionMinutes=clamp(+e.target.value||25,1,300); save(); if(selectedMode==='work') updateTimeText(S.sessionMinutes*60*1000); if(Timer.mode==='idle') Timer.reset(); };
  $('#goalInput').onchange=function(e){ S.goalMinutes=clamp(+e.target.value||25,10,600); save(); refreshStats(); queueSync(todayStr()); };
  Array.prototype.forEach.call(document.querySelectorAll('input[name="breakPolicy"]'),function(r){
    r.checked=(r.value===S.breakPolicy);
    r.addEventListener('change',function(){ S.breakPolicy=document.querySelector('input[name="breakPolicy"]:checked').value; save(); if(selectedMode==='break') updateTimeText(effBreak(S.sessionMinutes)*60*1000); });
  });
  $('#breakThresholdInput').onchange=function(e){ S.breakThreshold=clamp(+e.target.value||30,1,300); save(); if(selectedMode==='break') updateTimeText(effBreak(S.sessionMinutes)*60*1000); };
  $('#breakLenInput').onchange=function(e){ S.breakMinutes=clamp(+e.target.value||5,0,120); save(); updateBreakBadge(); if(selectedMode==='break') updateTimeText(effBreak(S.sessionMinutes)*60*1000); };

  // Notifications
  $('#notifyEnable').checked=!!S.notifyEnabled;
  $('#notifyEnable').onchange=function(e){ S.notifyEnabled=!!e.target.checked; save(); if(S.notifyEnabled) ensurePermission(); };

  // Public mirror toggle + copy URLs
  $('#pubMirrorEnable').checked=!!S.publicMirrorEnabled;
  $('#pubMirrorEnable').onchange=function(e){ S.publicMirrorEnabled=!!e.target.checked; save(); if(CLOUD.user) saveToCloud(); };

  // COPY: read-only URL
  $('#copyNotionUrl').onclick=function(){
    if(!(CLOUD && CLOUD.user)){ alert('Sign in first in the full app.'); return; }
    var base = window.location.href.split('#')[0].split('?')[0];
    var url = base + '?uid=' + encodeURIComponent(CLOUD.user.uid) + '&ns=' + encodeURIComponent(NS) + '&transparent=1';
    navigator.clipboard.writeText(url).then(function(){ showToast('Copied Notion read-only URL'); }, function(){ alert(url); });
  };

  // COPY: write-enabled URL (requires same key as your Function config)
  $('#copyNotionUrlWrite').onclick=function(){
    var key = S.notionSync.widgetKey || '';
    if (!key) { alert('Set a Widget key in Sync settings first. It must match your Function config.'); return; }
    var base = window.location.href.split('#')[0].split('?')[0];
    var url = base + '?key=' + encodeURIComponent(key) + '&ns=' + encodeURIComponent(NS) + '&transparent=1';
    navigator.clipboard.writeText(url).then(function(){ showToast('Copied Notion write URL'); }, function(){ alert(url); });
  };

  // Free-day tools
  $('#applyFreeYesterday').onclick=function(){ if(S.freeDayBank<=0){ alert("No free days in bank."); return; } var y=addDays(todayStr(),-1); var d=getDay(y); if(isSuccess(d)){ alert("Yesterday already counts as success."); return; } d.usedFreeDay=true; S.freeDayBank--; save(); refreshStats(); queueSync(y); };
  $('#manageMisses').onclick=function(){ var missed=[].concat(S.days).filter(function(d){return !isSuccess(d);}).slice(-60); if(!missed.length){ alert("No missed days to cover. üéâ"); return; } var input=prompt("Free days: "+S.freeDayBank+"\nDates to cover (comma-separated YYYY-MM-DD):\n"+missed.map(function(d){return "‚Ä¢ "+d.date+" ("+d.minutes+"m)";}).join('\n')); if(!input) return; var want=input.split(',').map(function(s){return s.trim();}).filter(Boolean); for(var i=0;i<want.length;i++){ var dt=want[i]; var dd=getDay(dt); if(!isSuccess(dd)&&S.freeDayBank>0){ dd.usedFreeDay=true; S.freeDayBank--; queueSync(dt); } } save(); refreshStats(); };

  // Notes / Todos
  $('#openNotes').onclick=function(){ showPanel('#panel-settings'); $('#notesBox').focus(); };
  $('#openTodos').onclick=function(){ showPanel('#panel-settings'); $('#todoBox').focus(); };
  $('#notesBox').value=S.notes||''; $('#notesBox').oninput=function(e){ S.notes=e.target.value; save(); };
  $('#todoBox').value=S.todos||''; $('#todoBox').oninput=function(e){ S.todos=e.target.value; save(); };

  // Background
  document.querySelectorAll('[data-bg]').forEach(function(btn){ btn.onclick=function(){ var mode=btn.getAttribute('data-bg');
    if(mode==='gradient'){ S.background.mode='gradient'; save(); applyBackground(); }
    if(mode==='image'){ var inp=document.createElement('input'); inp.type='file'; inp.accept='image/*'; inp.onchange=function(e){ var f=e.target.files[0]; if(!f) return; var r=new FileReader(); r.onload=function(){ S.background.imageDataUrl=r.result; S.background.mode='image'; save(); applyBackground(); }; r.readAsDataURL(f); }; inp.click(); }
    if(mode==='video'){ var url=prompt("Direct video URL (mp4/webm):"); if(url){ S.background.videoUrl=url; S.background.mode='video'; save(); applyBackground(); } }
    if(mode==='color'){ var c=prompt("HEX color (e.g., #101318):", S.background.color||'#0b0e14'); if(c){ S.background.color=c; S.background.mode='color'; save(); applyBackground(); } }
  };});
  $('#bgClear').onclick=function(){ S.background=deepClone(DEF.background); save(); applyBackground(); };

  // Notion sync inputs (optional)
  $('#syncEndpoint').value=S.notionSync.endpoint||''; $('#syncDb').value=S.notionSync.databaseId||''; $('#syncKey').value=S.notionSync.widgetKey||'';
  $('#syncEndpoint').onchange=function(e){ S.notionSync.endpoint=e.target.value.trim(); save(); };
  $('#syncDb').onchange=function(e){ S.notionSync.databaseId=e.target.value.trim(); save(); };
  $('#syncKey').onchange=function(e){ S.notionSync.widgetKey=e.target.value.trim(); save(); };
  $('#syncEnable').checked=!!S.notionSync.enabled;
  $('#syncEnable').onchange=function(e){ S.notionSync.enabled=!!e.target.checked; save(); if(S.notionSync.enabled) queueSync(todayStr()); };
  $('#syncNow').onclick=function(){ var t=todayStr(); var ds=[t]; for(var i=1;i<=7;i++) ds.push(addDays(t,-i)); ds.forEach(queueSync); alert("Sync queued (today + last 7)."); };

  // Keys
  document.addEventListener('keydown',function(e){ if(e.code==='Space'){ e.preventDefault(); $('#startStop').click(); } if(e.key==='r'||e.key==='R'){ Timer.reset(); } });
}

/* ===== Boot ===== */
function boot(){
  load();
  $('#tzLabel').textContent=Intl.DateTimeFormat().resolvedOptions().timeZone;
  applyBackground();
  setQuote();
  selectedMode='work'; Timer.reset();
  refreshStats();
  wire();
  initCloud();
  if(S.notifyEnabled) ensurePermission();

  setInterval(function(){
    var planned=(selectedMode==='work'? S.sessionMinutes : effBreak(S.sessionMinutes))*60000;
    var ms=(Timer.mode==='idle'||Timer.mode==='paused')? (Timer.mode==='paused'?Timer.remainingMs:planned) : Timer.remainingMs;
    document.title = fmtHM(ms)+' ‚Ä¢ Focus Clock';
    var c=$('#nowClock'); if(c) c.textContent=hms();
  },1000);
}
boot();
</script>
</body>
</html>
